<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Class Schedule</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 2rem;
      line-height: 1.6;
    }
    .container {
      background: #fff;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #222;
    }
    .label {
      font-weight: bold;
    }
    .countdown {
      font-size: 1.5rem;
      margin-top: 1rem;
      color: #0077cc;
    }
    a {
      color: #0077cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    ul {
      padding-left: 1.2rem;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome to Your Class Schedule</h1>
    <div id="content">
      <p>Hello, <span id="email-display">Loading...</span></p>

      <p><span class="label">Class Link:</span> <a href="#" id="class-link">Loading...</a></p>
      <p><span class="label">Notes Link:</span> <a href="#" id="notes-link">Loading...</a></p>

      <h2>Weekly Schedule:</h2>
      <ul id="weekly-schedule">Loading...</ul>

      <h2>Next Class:</h2>
      <div id="next-class-time">Loading...</div>
      <div class="countdown" id="countdown">Countdown loading...</div>
    </div>
    <p class="error" id="error-msg"></p>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get('email');
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const displayEmail = document.getElementById('email-display');
    const classLinkElem = document.getElementById('class-link');
    const notesLinkElem = document.getElementById('notes-link');
    const scheduleList = document.getElementById('weekly-schedule');
    const nextClassElem = document.getElementById('next-class-time');
    const countdownElem = document.getElementById('countdown');
    const errorElem = document.getElementById('error-msg');

    if (!email) {
      errorElem.textContent = "Email is missing in URL. Use ?email=your@email.com";
    } else {
      displayEmail.textContent = email;

      const API_URL = `https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjG_sjvzXVGwjtXNJYbrofHO3RBHzrsArc5LzvZ2c7Q5HLjqa-w-reNAxPjGX4OPgTEbeBBRCcCE4cuJ8k-yV6GECNsjMKfKJzSbxA84r-_8MavWD5XnpMqfaYZM2Pxb1-0dZreDqEGqMcToyEEObSAARqm7Pq6pZu9G46zKKk-mQP6-s9B0nGcwSAv0L2-4Dlk5iDllZL5VeYvWVNqWK43zK-LfdFmCSrwKkIp_iFM7nIJGJmaBjbzLAWEyydpLRL9g-W96P71Ta1_m_vbNeB2nUUwtw&lib=M74ZoQHRljJWxC6vIRFkyDp5vqXu_LAbk&email=${encodeURIComponent(email)}&timeZone=${encodeURIComponent(timezone)}`;

      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          if (data.classLink) {
            classLinkElem.href = data.classLink;
            classLinkElem.textContent = data.classLink;
          }

          if (data.notesLink) {
            notesLinkElem.href = data.notesLink;
            notesLinkElem.textContent = data.notesLink;
          }

          if (Array.isArray(data.weeklySchedule)) {
            scheduleList.innerHTML = '';
            data.weeklySchedule.forEach(item => {
              const li = document.createElement('li');
              li.textContent = `${item.day} at ${item.timeUTC} UTC`;
              scheduleList.appendChild(li);
            });
          }

          if (data.nextClassTime) {
            const classDate = new Date(data.nextClassTime);
            nextClassElem.textContent = classDate.toLocaleString(undefined, {
              dateStyle: 'full',
              timeStyle: 'short'
            });

            startCountdown(classDate);
          } else {
            countdownElem.textContent = "No upcoming class scheduled.";
          }
        })
        .catch(err => {
          console.error(err);
          errorElem.textContent = "Error fetching schedule.";
        });
    }

    function startCountdown(targetDate) {
      function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;

        if (diff <= 0) {
          countdownElem.textContent = "Class is starting now!";
          return;
        }

        const seconds = Math.floor((diff / 1000) % 60);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        countdownElem.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    }
  </script>
</body>
</html>
